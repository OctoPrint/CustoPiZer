set -x
set -e

export LC_ALL=C


source /common.sh
install_cleanup_trap


PIO_DIR=/home/pi/.pioreactor

sudo -u pi mkdir -p $PIO_DIR
sudo -u pi mkdir -p $PIO_DIR/storage
sudo -u pi mkdir -p $PIO_DIR/plugins

sudo -u pi mkdir -p /home/pi/.ssh/
sudo -u pi touch /home/pi/.ssh/authorized_keys
sudo -u pi touch /home/pi/.ssh/known_hosts


if [ -n "$LEADER" ]; then
    sudo apt install sshpass
    sudo -u pi cp /files/config.example.ini $PIO_DIR/config.ini
    sudo pip3 install "pioreactor[leader] @ https://github.com/Pioreactor/pioreactor/releases/download/$PIO_VERSION/pioreactor-$PIO_VERSION-py3-none-any.whl"
fi



if [ -n "$WORKER" ]; then
    sudo -u pi touch $PIO_DIR/unit_config.ini
    sudo apt-get install -y python3-numpy
    sudo pip3 install "pioreactor[worker] @ https://github.com/Pioreactor/pioreactor/releases/download/$PIO_VERSION/pioreactor-$PIO_VERSION-py3-none-any.whl"
fi

